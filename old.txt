"use client"

import { useState, useRef, useCallback } from "react"
import { Button } from "@/components/ui/button"
import { Card } from "@/components/ui/card"
import { Separator } from "@/components/ui/separator"
import { Input } from "@/components/ui/input"
import {
  Bold,
  Italic,
  Underline,
  AlignLeft,
  AlignCenter,
  AlignRight,
  AlignJustify,
  Download,
  Palette,
} from "lucide-react"

interface TextStyle {
  bold: boolean
  italic: boolean
  underline: boolean
  fontSize: number
  color: string
  align: "left" | "center" | "right" | "justify"
}

export function TextEditor() {
  const [text, setText] = useState("")
  const [title, setTitle] = useState("")
  const [style, setStyle] = useState<TextStyle>({
    bold: false,
    italic: false,
    underline: false,
    fontSize: 11,
    color: "#737373",
    align: "left",
  })

  const canvasRef = useRef<HTMLCanvasElement>(null)

  const toggleStyle = (property: keyof Pick<TextStyle, "bold" | "italic" | "underline">) => {
    setStyle((prev) => ({ ...prev, [property]: !prev[property] }))
  }

  const setAlignment = (align: TextStyle["align"]) => {
    setStyle((prev) => ({ ...prev, align }))
  }

  const changeFontSize = (delta: number) => {
    setStyle((prev) => ({
      ...prev,
      fontSize: Math.max(8, Math.min(72, prev.fontSize + delta)),
    }))
  }

  const changeColor = (color: string) => {
    setStyle((prev) => ({ ...prev, color }))
  }

  const getTextStyle = () => {
    return {
      fontWeight: style.bold ? "bold" : "normal",
      fontStyle: style.italic ? "italic" : "normal",
      textDecoration: style.underline ? "underline" : "none",
      fontSize: `${style.fontSize}px`,
      color: style.color,
      textAlign: style.align as any,
      lineHeight: "1.5",
      fontFamily: "system-ui, -apple-system, sans-serif",
    }
  }

  const downloadAsPNG = useCallback(() => {
    const canvas = canvasRef.current
    if (!canvas || !text.trim()) return

    const ctx = canvas.getContext("2d")
    if (!ctx) return

    const dpr = (window.devicePixelRatio || 1) * 4
    const previewContainerWidth = 600
    const padding = 24
    const availableWidth = previewContainerWidth - padding * 2

    const font = `${style.italic ? "italic " : ""}${style.bold ? "bold " : ""}${style.fontSize}px system-ui, -apple-system, sans-serif`
    ctx.font = font

    const lineHeight = style.fontSize * 1.5
    const paragraphs = text.split('\n')
    const wrappedLines: string[] = []

    paragraphs.forEach(paragraph => {
      if (paragraph.trim() === '') {
        wrappedLines.push('')
      } else {
        const words = paragraph.split(' ')
        let currentLine = words[0] || ''

        for (let i = 1; i < words.length; i++) {
          const word = words[i]
          const testLine = `${currentLine} ${word}`
          const metrics = ctx.measureText(testLine)
          if (metrics.width > availableWidth && currentLine.length > 0) {
            wrappedLines.push(currentLine)
            currentLine = word
          } else {
            currentLine = testLine
          }
        }
        wrappedLines.push(currentLine)
      }
    })

    let maxWidth = 0
    wrappedLines.forEach(line => {
      const metrics = ctx.measureText(line)
      if (metrics.width > maxWidth) {
        maxWidth = metrics.width
      }
    })

    const textHeight = wrappedLines.length * lineHeight

    const canvasWidth = Math.ceil(maxWidth)
    const canvasHeight = Math.ceil(textHeight - (lineHeight - style.fontSize))

    canvas.width = canvasWidth * dpr
    canvas.height = canvasHeight * dpr
    canvas.style.width = `${canvasWidth}px`
    canvas.style.height = `${canvasHeight}px`

    ctx.scale(dpr, dpr)
    ctx.clearRect(0, 0, canvas.width, canvas.height)

    ctx.font = font
    ctx.fillStyle = style.color
    ctx.textBaseline = "top"

    wrappedLines.forEach((line, index) => {
      const y = index * lineHeight
      let x = 0
      const textWidth = ctx.measureText(line).width

      if (style.align === "center") {
        x = (canvasWidth - textWidth) / 2
      } else if (style.align === "right") {
        x = canvasWidth - textWidth
      }

      ctx.fillText(line, x, y)

      if (style.underline) {
        ctx.beginPath()
        ctx.moveTo(x, y + style.fontSize + 2)
        ctx.lineTo(x + textWidth, y + style.fontSize + 2)
        ctx.strokeStyle = style.color
        ctx.lineWidth = 1
        ctx.stroke()
      }
    })

    canvas.toBlob((blob) => {
      if (blob) {
        const url = URL.createObjectURL(blob)
        const a = document.createElement("a")
        a.href = url
        a.download = title ? `${title}.png` : "text-editor-export.png"
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)
      }
    }, "image/png")
  }, [text, style, title])

  return (
    <div className="w-full max-w-7xl mx-auto space-y-6">
      <Card className="p-6 bg-white/95 backdrop-blur-sm border-white/20 shadow-xl">
        <div className="flex flex-wrap items-center gap-3">
          {/* Text Formatting */}
          <div className="flex items-center gap-2">
            <Button
              variant={style.bold ? "default" : "outline"}
              size="sm"
              onClick={() => toggleStyle("bold")}
              className={`h-10 w-10 p-0 transition-all duration-200 ${
                style.bold
                  ? "bg-gradient-to-r from-pink-400 to-purple-500 hover:from-pink-500 hover:to-purple-600 text-white shadow-lg border-0"
                  : "hover:bg-gradient-to-r hover:from-pink-100 hover:to-purple-100 hover:border-pink-300 border-purple-200"
              }`}
            >
              <Bold className="h-4 w-4" />
            </Button>
            <Button
              variant={style.italic ? "default" : "outline"}
              size="sm"
              onClick={() => toggleStyle("italic")}
              className={`h-10 w-10 p-0 transition-all duration-200 ${
                style.italic
                  ? "bg-gradient-to-r from-pink-400 to-purple-500 hover:from-pink-500 hover:to-purple-600 text-white shadow-lg border-0"
                  : "hover:bg-gradient-to-r hover:from-pink-100 hover:to-purple-100 hover:border-pink-300 border-purple-200"
              }`}
            >
              <Italic className="h-4 w-4" />
            </Button>
            <Button
              variant={style.underline ? "default" : "outline"}
              size="sm"
              onClick={() => toggleStyle("underline")}
              className={`h-10 w-10 p-0 transition-all duration-200 ${
                style.underline
                  ? "bg-gradient-to-r from-pink-400 to-purple-500 hover:from-pink-500 hover:to-purple-600 text-white shadow-lg border-0"
                  : "hover:bg-gradient-to-r hover:from-pink-100 hover:to-purple-100 hover:border-pink-300 border-purple-200"
              }`}
            >
              <Underline className="h-4 w-4" />
            </Button>
          </div>

          <Separator orientation="vertical" className="h-8 bg-gradient-to-b from-pink-200 to-purple-200" />

          {/* Font Size */}
          <div className="flex items-center gap-2 bg-gradient-to-r from-pink-50 to-purple-50 rounded-lg p-1 border border-pink-200">
            <Button
              variant="outline"
              size="sm"
              onClick={() => changeFontSize(-1)}
              className="h-8 w-8 p-0 hover:bg-gradient-to-r hover:from-pink-100 hover:to-purple-100 hover:border-pink-300 border-purple-200 transition-all duration-200"
            >
              -
            </Button>
            <span className="text-sm font-semibold min-w-[3.5rem] text-center px-2 py-1 bg-white rounded border border-pink-200">
              {style.fontSize}px
            </span>
            <Button
              variant="outline"
              size="sm"
              onClick={() => changeFontSize(1)}
              className="h-8 w-8 p-0 hover:bg-gradient-to-r hover:from-pink-100 hover:to-purple-100 hover:border-pink-300 border-purple-200 transition-all duration-200"
            >
              +
            </Button>
          </div>

          <Separator orientation="vertical" className="h-8 bg-gradient-to-b from-pink-200 to-purple-200" />

          {/* Alignment */}
          <div className="flex items-center gap-2">
            <Button
              variant={style.align === "left" ? "default" : "outline"}
              size="sm"
              onClick={() => setAlignment("left")}
              className={`h-10 w-10 p-0 transition-all duration-200 ${
                style.align === "left"
                  ? "bg-gradient-to-r from-pink-400 to-purple-500 hover:from-pink-500 hover:to-purple-600 text-white shadow-lg border-0"
                  : "hover:bg-gradient-to-r hover:from-pink-100 hover:to-purple-100 hover:border-pink-300 border-purple-200"
              }`}
            >
              <AlignLeft className="h-4 w-4" />
            </Button>
            <Button
              variant={style.align === "center" ? "default" : "outline"}
              size="sm"
              onClick={() => setAlignment("center")}
              className={`h-10 w-10 p-0 transition-all duration-200 ${
                style.align === "center"
                  ? "bg-gradient-to-r from-pink-400 to-purple-500 hover:from-pink-500 hover:to-purple-600 text-white shadow-lg border-0"
                  : "hover:bg-gradient-to-r hover:from-pink-100 hover:to-purple-100 hover:border-pink-300 border-purple-200"
              }`}
            >
              <AlignCenter className="h-4 w-4" />
            </Button>
            <Button
              variant={style.align === "right" ? "default" : "outline"}
              size="sm"
              onClick={() => setAlignment("right")}
              className={`h-10 w-10 p-0 transition-all duration-200 ${
                style.align === "right"
                  ? "bg-gradient-to-r from-pink-400 to-purple-500 hover:from-pink-500 hover:to-purple-600 text-white shadow-lg border-0"
                  : "hover:bg-gradient-to-r hover:from-pink-100 hover:to-purple-100 hover:border-pink-300 border-purple-200"
              }`}
            >
              <AlignRight className="h-4 w-4" />
            </Button>
            <Button
              variant={style.align === "justify" ? "default" : "outline"}
              size="sm"
              onClick={() => setAlignment("justify")}
              className={`h-10 w-10 p-0 transition-all duration-200 ${
                style.align === "justify"
                  ? "bg-gradient-to-r from-pink-400 to-purple-500 hover:from-pink-500 hover:to-purple-600 text-white shadow-lg border-0"
                  : "hover:bg-gradient-to-r hover:from-pink-100 hover:to-purple-100 hover:border-pink-300 border-purple-200"
              }`}
            >
              <AlignJustify className="h-4 w-4" />
            </Button>
          </div>

          <Separator orientation="vertical" className="h-8 bg-gradient-to-b from-pink-200 to-purple-200" />

          {/* Color Picker */}
          <div className="flex items-center gap-3 bg-gradient-to-r from-pink-50 to-purple-50 rounded-lg p-2 border border-pink-200">
            <Palette className="h-4 w-4 text-purple-600" />
            <input
              type="color"
              value={style.color}
              onChange={(e) => changeColor(e.target.value)}
              className="w-10 h-10 rounded-lg border-2 border-pink-300 shadow-md cursor-pointer hover:scale-105 transition-transform duration-200"
            />
          </div>

          <Separator orientation="vertical" className="h-8 bg-gradient-to-b from-pink-200 to-purple-200" />

          {/* Title Input Field */}
          <div className="flex items-center gap-3">
            <Input
              type="text"
              placeholder="Image title (optional)"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              className="w-48 h-10 bg-white/80 border-pink-200 focus:border-purple-400 focus:ring-purple-200 transition-all duration-200"
            />
          </div>

          <Separator orientation="vertical" className="h-8 bg-gradient-to-b from-pink-200 to-purple-200" />

          {/* Export */}
          <Button
            onClick={downloadAsPNG}
            className="bg-gradient-to-r from-pink-400 via-purple-500 to-blue-500 hover:from-pink-500 hover:via-purple-600 hover:to-blue-600 text-white shadow-lg hover:shadow-xl transition-all duration-200 px-6 h-10 border-0"
            size="sm"
          >
            <Download className="h-4 w-4 mr-2" />
            Export PNG
          </Button>
        </div>
      </Card>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[600px]">
        {/* Text Editor */}
        <Card className="p-6 bg-white/95 backdrop-blur-sm border-white/20 shadow-xl">
          <h3 className="text-xl font-bold mb-4 gradient-text">Editor</h3>
          <textarea
            value={text}
            onChange={(e) => setText(e.target.value)}
            className="w-full h-full resize-none border-0 outline-none bg-transparent text-foreground placeholder:text-muted-foreground focus:ring-0 rounded-lg p-4 bg-gradient-to-br from-pink-50/30 to-purple-50/30"
            placeholder="Start typing your text here..."
            style={{
              fontSize: "16px",
              lineHeight: "1.6",
              fontFamily: "system-ui, -apple-system, sans-serif",
            }}
          />
        </Card>

        {/* Preview */}
        <Card className="p-6 bg-white/95 backdrop-blur-sm border-white/20 shadow-xl">
          <h3 className="text-xl font-bold mb-4 gradient-text">Preview</h3>
          <div
            className="h-full overflow-auto rounded-lg border-2 border-dashed border-purple-300 p-6 bg-white/50"
            style={{
              ...getTextStyle(),
              maxWidth: "100%",
              wordWrap: "break-word",
              whiteSpace: "pre-wrap",
            }}
          >
            {text.split("\n").map((line, index) => (
              <div key={index} className="min-h-[1.5em]" style={{ textAlign: style.align as any }}>
                {line || " "}
              </div>
            ))}
          </div>
        </Card>
      </div>

      {/* Hidden Canvas for Export */}
      <canvas ref={canvasRef} className="hidden" />
    </div>
  )
}